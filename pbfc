#!/bin/bash
# Programble's Brainfuck Compiler
# Copyright 2010 Curtis McEnroe <programble@gmail.com>
# Licensed under the WTFPL

# Settings:
CC=cc

# Exit if no input file was given
[ -z $1 ] && exit 1
# Make sure input file exists
[ -f $1 ] || exit 1

# Get array size from second argument, defaults to 5000
SIZE=5000
[ $2 ] && SIZE=$2

# Filenames
TMPFILE=$1.tmp
CFILE=$1.c
OFILE=${CFILE/.bf.c/}

# Standard C code
echo "/* Generated by PBFC" > $CFILE
echo " * From Brainfuck source file $1:" >> $CFILE
cat $1 >> $CFILE
echo " */" >> $CFILE
echo "#include <string.h>" >> $CFILE
echo "#include <stdio.h>" >> $CFILE
echo "int main() {" >> $CFILE
echo "unsigned char cells[$SIZE];" >> $CFILE
echo "memset(cells, 0, $SIZE);" >> $CFILE
echo "unsigned char* ptr = cells;" >> $CFILE

# Strip regular characters (comments)
sed 's/[a-zA-Z0-9`~!@#$%^&*()=_{}\|;:"/?]//g' $1 > $TMPFILE

# Translate brainfuck commands to C
sed 's/+/(*ptr)++;\n/g; s/-/(*ptr)--;\n/g; s/\./putchar(*ptr);\n/g; s/,/*ptr=getchar()\n;/g; s/\[/while (*ptr) {\n/g; s/\]/}\n/g; s/>/ptr++;\n/g; s/</ptr--;\n/g;' $TMPFILE >> $CFILE

# Standard ending
echo "return 0;}" >> $CFILE

# Remove temporary file
rm $TMPFILE

# Compile generated C code
$CC -o $OFILE $CFILE
exit $?
